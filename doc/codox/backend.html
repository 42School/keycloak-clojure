<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Securing a backend</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/github.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h1><a href="index.html"><span class="project-title"><span class="project-name">keycloak-clojure</span> <span class="project-version">1.14.4</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="concepts.html"><div class="inner"><span>Security Concepts</span></div></a></li><li class="depth-1 "><a href="setup.html"><div class="inner"><span>Setup Keycloak</span></div></a></li><li class="depth-1 "><a href="admin.html"><div class="inner"><span>Administrative tasks</span></div></a></li><li class="depth-1 "><a href="frontend.html"><div class="inner"><span>Securing a frontend</span></div></a></li><li class="depth-1  current"><a href="backend.html"><div class="inner"><span>Securing a backend</span></div></a></li><li class="depth-1 "><a href="howtos.html"><div class="inner"><span>HOWTOs</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>keycloak</span></div></div></li><li class="depth-2 branch"><a href="keycloak.admin.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>admin</span></div></a></li><li class="depth-2 branch"><a href="keycloak.authn.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>authn</span></div></a></li><li class="depth-2 branch"><a href="keycloak.authz.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>authz</span></div></a></li><li class="depth-2 branch"><a href="keycloak.backend.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>backend</span></div></a></li><li class="depth-2 branch"><a href="keycloak.bean.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bean</span></div></a></li><li class="depth-2 branch"><a href="keycloak.cookies.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cookies</span></div></a></li><li class="depth-2 branch"><a href="keycloak.deployment.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>deployment</span></div></a></li><li class="depth-2 branch"><a href="keycloak.meta.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>meta</span></div></a></li><li class="depth-2 branch"><a href="keycloak.starter.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>starter</span></div></a></li><li class="depth-2 branch"><a href="keycloak.user.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>user</span></div></a></li><li class="depth-2 branch"><a href="keycloak.utils.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>utils</span></div></a></li><li class="depth-2"><a href="keycloak.vault.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>vault</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#securing-a-backend" name="securing-a-backend"></a>Securing a backend</h1>
<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
<ul>
  <li><a href="#backend-with-yada">Backend with Yada</a></li>
  <li><a href="#backend-with-ring-and-buddy-auth">Backend with Ring and Buddy-Auth</a></li>
</ul>
<!-- markdown-toc end -->
<h2><a href="#backend-with-yada" name="backend-with-yada"></a>Backend with Yada</h2>
<p>The client is correctly configured and is sending either a cookie or a header containing a token with every request. The backend must:</p>
<ol>
  <li>Extract the token from the cookie or the header (Yada framework specific)</li>
  <li><strong>Verify the token (Keycloak stuff)</strong></li>
  <li>Ensure the client is accessing the restricted part only if the token is correct (this is Yada specific, read the excellent <a href="https://juxt.pro/blog/posts/yada-authentication.html">Yada article “Speak friend and Enter!”</a>)</li>
</ol>
<p>The code is in <a href="https://github.com/jgrodziski/keycloak-clojure/blob/master/backend/src/myapp/backend/server.clj">server.clj</a> calling some functions in <a href="https://github.com/jgrodziski/keycloak-clojure/blob/master/backend/src/myapp/backend/keycloak.clj">keycloak.clj</a>.</p>
<pre><code class="clojure">;;1. Extract the token from the cookie or the header (Yada framework specific)
(defn authorization-token-cookie [ctx]
  (let [cookies (parse-cookies (:request ctx))]
    (get cookies "X-Authorization-Token")))

(defmethod yada.security/verify :keycloak
  [ctx scheme]
  (let [header-cred (authorization-bearer-cred ctx)
        cookie-cred (authorization-token-cookie ctx)]
    (-&gt; (or header-cred cookie-cred)
        ;; Verify the token (Keycloak stuff)
        (keycloak/verify)
        (keycloak/extract))))

(defn- restricted-content [ctx]
  (html5
   [:body
    [:h1 (format "Hello %s!"
                 (get-in ctx [:authentication "default" :user]))]
    [:p "You're accessing a restricted resource!"]]))

(def routes
  ["/"
   [
    ["hello" ( handler (as-resource "Hello world!"))]
    ["restricted" (resource {:consumes #{"application/json"}
                             :produces {:media-type "text/html"}
                             :methods {:post (fn [ctx] (restricted-content ctx))}
                             ;;Ensure the client is accessing the restricted part only if the token is correct
                             :access-control {:scheme :keycloak
                                              :allow-origin "http://localhost:3449"
                                              :allow-credentials true
                                              :allow-methods #{:get :post :options}
                                              :allow-headers ["Content-Type"
                                                              "Access-Control-Allow-Headers"
                                                              "Authorization"
                                                              "X-Requested-With"
                                                              "X-Authorization-Token"]
                              :authorization {:methods {:get :employee :post :employee}}}})]
    [true (as-resource nil)]]])

(defstate server
  :start (listener routes {:port 8084})
  :stop ((:close server)))
</code></pre>
<h2><a href="#backend-with-ring-and-buddy-auth" name="backend-with-ring-and-buddy-auth"></a>Backend with Ring and Buddy-Auth</h2>
<p>TODO</p></div></div></div></body></html>